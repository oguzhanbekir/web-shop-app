<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Admin Paneli</title>

    <!-- Bootstrap core CSS-->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">

    <!-- Page level plugin CSS-->
    <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin.css" rel="stylesheet">

  </head>

  <body id="page-top">

    <nav class="navbar navbar-expand navbar-dark bg-dark static-top">

      <a class="navbar-brand mr-1" href="adminpanel.html">Admin Paneli</a>

      <button class="btn btn-link btn-sm text-white order-1 order-sm-0" id="sidebarToggle" href="#">
        <i class="fas fa-bars"></i>
      </button>

      <!-- Navbar Search -->
      <form class="d-none d-md-inline-block form-inline ml-auto mr-0 mr-md-3 my-2 my-md-0">
        <div class="input-group">

        </div>
      </form>

      <!-- Navbar -->
      <ul class="navbar-nav ml-auto ml-md-0">
        <li class="nav-item dropdown no-arrow">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user-circle fa-fw"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item" href="adminpanel.html">Hesabım</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="../index.php" id="logout">Çıkış Yap</a>
          </div>
        </li>
      </ul>

    </nav>

    <div id="wrapper">

      <!-- Sidebar -->
      <ul class="sidebar navbar-nav">
        <li class="nav-item">
              <a class="nav-link" href="adminpanel.html">
                <i class="fas fa-user-circle"></i>
                <span>Kişisel Bilgilerim</span></a>
        </li>
        <li class="nav-item">
              <a class="nav-link" href="adminpanel_brand.html">
                <i class="fas fa-fw fa-table"></i>
                <span>Marka Ekle</span></a>
        </li>
        <li class="nav-item">
              <a class="nav-link" href="adminpanel_category.html">
                <i class="fas fa-fw fa-table"></i>
                <span>Kategori Ekle</span></a>
        </li>
        <li class="nav-item">
              <a class="nav-link" href="adminpanel_product.html">
                <i class="fas fa-fw fa-table"></i>
                <span>Ürün Ekle</span></a>
        </li>
        <li class="nav-item active">
              <a class="nav-link" href="adminpanel_marketsettings.html">
                <i class="fas fa-fw fa-table"></i>
                <span>Market Ayarları</span></a>
        </li>
        <li class="nav-item">
              <a class="nav-link" href="adminpanel_neighborhood.html">
                <i class="fas fa-fw fa-table"></i>
                <span>Bölge Ayarları</span></a>
        </li>
        <li class="nav-item">
              <a class="nav-link" href="adminpanel_user.html">
                <i class="fas fa-fw fa-table"></i>
                <span>Kullanıcı Ayarları</span></a>
        </li>
      </ul>

      <div id="content-wrapper">

        <div class="container-fluid">

          <!-- Breadcrumbs-->
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="orders.html">Admin</a>
            </li>
            <li class="breadcrumb-item active">Tablolar</li>
          </ol>

          <!-- DataTables Example -->
          <div class="card mb-3">
            <div class="card-header">
              <i class="fas fa-table"></i> Market Ayarları
            </div>
            <div class="card-body">
              <div id="accordion">
                <div class="card">
                  <div class="card-header" id="headingOne">
                    <h5 class="mb-0">
                      <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        Market Oluşturma
                      </button>
                    </h5>
                  </div>
                  <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">

                        <table class="table table-bordered table-striped" id="shopUnitApplies">
                          <tr>
                            <th>Kullanıcı ID</th>
                            <th>Market Adı</th>
                            <th>Market Adresi</th>
                            <th>Minimum Servis Ücreti</th>
                            <th>Market Telefonu</th>
                            <th>Market E-Mail</th>
                            <th>Status</th>

                          </tr>
                        </table>

                    </div>
                  </div>
                </div>
              </div>


            </div>

          </div>

          <p class="small text-center text-muted my-5">
          </p>

        </div>
        <!-- /.container-fluid -->

        <!-- Sticky Footer -->
        <footer class="sticky-footer">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span>Hesaplı Marketim © 2019</span>
            </div>
          </div>
        </footer>

      </div>
      <!-- /.content-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Page level plugin JavaScript-->
    <script src="vendor/datatables/jquery.dataTables.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin.min.js"></script>

    <!-- Demo scripts for this page-->
    <script src="js/demo/datatables-demo.js"></script>
    <script src="../js/main.js"></script>
    <div class="modal" tabindex="-1" role="dialog" id="modal_shopUnitapplydetail">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Market Ayarları</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <form id="marketSetting" method="post">
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Kullanıcı ID</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" name="user" id="marketSetting_userId" placeholder="Kullanıcı ID">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Market Adı</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" name="name" id="marketSetting_marketname" placeholder="Market Adı">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Minimum Servis Ücreti</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="marketSetting_minorder">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Market Telefonu</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="marketSetting_phone">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Market E-Mail</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="marketSetting_email">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Market Adresi</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="marketSetting_address">
                    </div>
                  </div>


                  <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Market Logo</label>
                    <div class="col-sm-10">
                      <input type="file" name="logo"/>
                    </div>
                  </div>
          </div>
          <div class="modal-footer">
              <button type="submit" class="btn btn-primary" id="shopUnitapplydetail_button">Kaydet</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
  function parseJwt_userId (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var deneme=JSON.parse(window.atob(base64));
        return deneme.userId;
  };
  function parseJwt_userType (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var deneme=JSON.parse(window.atob(base64));
        return deneme.userType;
    };
  $(document).ready(function(){
    var shopUnitApplies;
    var token = $.parseJSON(localStorage.getItem('Token'));
      if (token == null  || parseJwt_userType(token)!="5c1d176670920532900b6a5f") {
          location.href="../404.php";
          return;
      }else{

        $("#marketSetting").on('submit', function (event)
          {
              event.preventDefault();
              var form = $(this)[0];
              var data = new FormData(form);
              $.ajax({
                  type: "POST",
                  url: "http://localhost:3000/shops",
                  data: data,
                  dataType: "json",
              processData: false,
              contentType: false,
              success: function (jsonStr) {
                var shop_id = jsonStr.createdShop._id;
                var user_id = jsonStr.createdShop.user;
                var shop_name =jsonStr.createdShop.name;

                var request = new XMLHttpRequest();
                request.open('PATCH', 'http://localhost:3000/user/usertype/'+user_id+'?userType=2', false);
                request.setRequestHeader("Content-type","application/json");
                request.send();
                $.getJSON("http://localhost:3000/user/"+user_id, function (data) {
                  $.ajax({
                  url: "http://localhost:3000/shopUnits",
                  type: "POST",
                  data: {
                      name: shop_name,
                      shop: shop_id,
                      address: $('#marketSetting_address').val(),
                      min_order:$('#marketSetting_minorder').val(),
                      phone:data.phone,
                      email:data.email
                  },
                  dataType: "JSON",
                  success: function (jsonStr) {
                        alert("Market Başarıyla Oluşturuldu");
                        var request = new XMLHttpRequest();
                        request.open('PATCH', 'http://localhost:3000/shopUnitApplies/'+shopUnitApplies, false);
                        request.setRequestHeader("Content-type","application/json");
                        request.send('[{"propName": "status","value":"true"}]');
                  },
                  error: function (xhr, status, error) {
                      alert("Market Oluşturulamadı");
                  }
                  });
                });


              },
              error: function (xhr, status, error) {
                  alert("Market Oluşturulamadı");
              }
              });
          });


          $.getJSON("http://localhost:3000/shopUnitApplies",function(data){

            var shopunitApply_data='';

              $.each(data.shopUnitApply, function(k,v){
                if(v.status==false){
                  shopunitApply_data +='<tr>';
                  shopunitApply_data += '<td>'+v.shopUser+'</td>';
                  shopunitApply_data += '<td>'+v.shopName+'</td>';
                  shopunitApply_data += '<td>'+v.shopUnitAddress+'</td>';
                  shopunitApply_data += '<td>'+v.shopUnitMin_order+'</td>';
                  shopunitApply_data += '<td>'+v.shopUnitPhone+'</td>';
                  shopunitApply_data += '<td>'+v.shopUnitEmail+'</td>';
                  shopunitApply_data += '<td>'+v.status+'</td>';
                  shopunitApply_data += '<td><a data-toggle="modal" href="#modal_shopUnitapplydetail" class="shopUnitapplydetail"  id="'+v._id+'"><i class="fas fa-check-circle"></i></a></td>';
                  shopunitApply_data +='<tr>';
                  }
                  });



                $('#shopUnitApplies').append(shopunitApply_data);

                      $(".shopUnitapplydetail").click(function(){
                        shopUnitApplies=$(this).attr('id');
                          $.getJSON("http://localhost:3000/shopUnitApplies/"+shopUnitApplies,function(data){
                            $('#marketSetting_userId').val(data.shopUnitApply.shopUser);
                            $('#marketSetting_marketname').val(data.shopUnitApply.shopName);
                            $('#marketSetting_minorder').val(data.shopUnitApply.shopUnitMin_order);
                            $('#marketSetting_phone').val(data.shopUnitApply.shopUnitPhone);
                            $('#marketSetting_email').val(data.shopUnitApply.shopUnitEmail);
                            $('#marketSetting_address').val(data.shopUnitApply.shopUnitAddress);

                          });

                      });
          });

      }




  });



  </script>

</html>
